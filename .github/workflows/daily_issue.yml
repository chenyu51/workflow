name: Daily Issue Automation

on:
  # Cron is in UTC. 11:00 UTC ≈ 06:00 Toronto (EST) / 07:00 Toronto (EDT).
  # Adjust the hour/minute here if you want a different local time.
  schedule:
    - cron: '0 11 * * 1-5'
  workflow_dispatch:

permissions:
  issues: write

jobs:
  create-daily-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Create or reuse daily issue
        uses: actions/github-script@v7
        with:
          script: |
            const tz = 'America/Toronto';
            const today = new Date(new Date().toLocaleString('en-US', { timeZone: tz }));
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const title = `${year}-${month}-${day} Daily`;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            async function ensureLabel(name) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name });
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({ owner, repo, name, color: 'cfd3d7', description: 'Auto-created for growth workflow' });
                } else {
                  throw error;
                }
              }
            }

            const existing = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: 'open',
              per_page: 100,
            });
            if (existing.find((issue) => issue.title === title)) {
              core.info(`Issue "${title}" already exists and is open. Skipping creation.`);
              return;
            }

            await ensureLabel('daily');

            const body = `## 今天我主要做了什么？（事实 3-5条）\n- [ ]\n\n## 哪件事让我变强了一点？\n- [ ]\n\n## 如果重来一次，我会怎么做？（1条改进）\n- [ ]\n`;

            await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels: ['daily'],
            });
