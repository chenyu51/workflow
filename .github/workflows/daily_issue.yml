name: Daily Issue Automation (Growth OS v2)

on:
  # Cron uses UTC. Beijing = UTC+8 with no daylight saving time.
  # Beijing 09:00 (UTC+8) â†’ UTC 01:00.
  schedule:
    - cron: '0 1 * * 1-5'
  workflow_dispatch:

permissions:
  issues: write

jobs:
  create-daily-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Create or reuse daily issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const beijing = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Shanghai' }));
            const year = beijing.getFullYear();
            const month = String(beijing.getMonth() + 1).padStart(2, '0');
            const day = String(beijing.getDate()).padStart(2, '0');
            const title = `${year}-${month}-${day} Daily`;

            const epochDays = Math.floor(beijing.getTime() / 86400000);
            const modules = ['BASE', 'THINKING', 'RADAR', 'VALUE'];
            const moduleToday = modules[epochDays % modules.length];

            function readJson(fileName) {
              const fullPath = path.join(process.cwd(), '.github', 'data', fileName);
              return JSON.parse(fs.readFileSync(fullPath, 'utf8'));
            }

            function readMilton(fileName) {
              const fullPath = path.join(process.cwd(), '.github', 'data', 'milton', fileName);
              return JSON.parse(fs.readFileSync(fullPath, 'utf8'));
            }

            const thinkingPrompts = readJson('thinking_prompts.json');
            const radarTopics = readJson('radar_topics.json');
            const businessRoles = readJson('business_roles.json');
            const miltonPatterns = readMilton('patterns.json');
            const miltonDrills = readMilton('drills_14d.json');

            const existing = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: 'open',
              per_page: 100,
            });
            if (existing.find((issue) => issue.title === title)) {
              core.info(`Issue "${title}" already exists and is open. Skipping creation.`);
              return;
            }

            async function ensureLabel(name) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name });
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({ owner, repo, name, color: 'cfd3d7', description: 'Auto-created for growth workflow' });
                } else {
                  throw error;
                }
              }
            }
            await ensureLabel('daily');

            const baseSection = `## åŸºç¡€ä¸‰é—®\n- ä»Šå¤©æˆ‘åšäº†ä»€ä¹ˆï¼ˆäº‹å® 3-5æ¡ï¼‰ï¼Ÿ\n- å“ªä»¶äº‹è®©æˆ‘å˜å¼ºäº†ä¸€ç‚¹ï¼Ÿ\n- å¦‚æœé‡æ¥ä¸€æ¬¡ï¼Œæˆ‘ä¼šæ€ä¹ˆåšï¼ˆ1æ¡æ”¹è¿›ï¼‰ï¼Ÿ\n\næƒ…ç»ª/èƒ½é‡ï¼š`;

            const thinkingPrompt = thinkingPrompts[epochDays % thinkingPrompts.length];
            const radarTopic = radarTopics[epochDays % radarTopics.length];
            const role = businessRoles[(epochDays * 3) % businessRoles.length];

            const moduleSections = {
              BASE: `${baseSection}\n\nä»Šæ—¥æ¨¡å—ï¼šBASEï¼ˆåŸºç¡€ç»ƒä¹ ï¼‰\n- æŒ‰åŸºç¡€ä¸‰é—®å¿«é€Ÿè®°å½•ï¼Œä¿æŒèŠ‚å¥ã€‚`,
              THINKING: `${baseSection}\n\nä»Šæ—¥æ¨¡å—ï¼šTHINKINGï¼ˆç»“æ„åŒ–æ€è€ƒï¼‰\nä¸»é¢˜ï¼š${thinkingPrompt.theme}\næç¤ºï¼š${thinkingPrompt.questions.map((q) => `\n- ${q}`).join('')}\näº§å‡ºæ ¼å¼ï¼š${thinkingPrompt.output}`,
              RADAR: `${baseSection}\n\nä»Šæ—¥æ¨¡å—ï¼šRADARï¼ˆèµ„è®¯é›·è¾¾ + èŒä¸šæ ·æœ¬ï¼‰\nä»Šæ—¥é›·è¾¾ä¸»é¢˜ï¼š${radarTopic}\næ€è€ƒå››é—®ï¼šå‘ç”Ÿäº†ä»€ä¹ˆ / å½±å“è° / æ”¹å˜ä»€ä¹ˆ / å¯¹æˆ‘æ„å‘³ç€ä»€ä¹ˆ\nä»Šæ—¥èŒä¸š/ç”Ÿæ„æ ·æœ¬ï¼š${role}\nä¸‰é—®ï¼šä»–ä»¬å¦‚ä½•èµšé’± / æ ¸å¿ƒèƒ½åŠ› / æˆ‘å·®è·æ˜¯ä»€ä¹ˆ`,
              VALUE: `${baseSection}\n\nä»Šæ—¥æ¨¡å—ï¼šVALUEï¼ˆä»·å€¼æç‚¼ï¼‰\næŠŠä»Šå¤©çš„è¡ŒåŠ¨æ”¹å†™æˆä»·å€¼ï¼š\n- å¯¹å®¢æˆ·/ç”¨æˆ·ä»·å€¼\n- å¯¹æ”¶å…¥/æˆæœ¬/æ•ˆç‡\n- å¯¹é£é™©/è´¨é‡/ç¨³å®šæ€§\n- å¯¹ç»„ç»‡åä½œ/çŸ¥è¯†æ²‰æ·€\n\nä¸€å¥è¯æ¨¡æ¿ï¼ˆä»»é€‰å…¶ä¸€ï¼‰ï¼š\n1) é€šè¿‡ã€åŠ¨ä½œã€‘è®©ã€å¯¹è±¡ã€‘çš„ã€æŒ‡æ ‡ã€‘æå‡/ä¸‹é™äº†ã€ç»“æœã€‘\n2) è§£å†³äº†ã€é—®é¢˜/é£é™©ã€‘ï¼Œå¸¦æ¥äº†ã€æ”¶ç›Š/é¿å…çš„æŸå¤±ã€‘\n3) ä¸ºã€å›¢é˜Ÿ/å®¢æˆ·ã€‘å»ºç«‹äº†ã€èµ„äº§/æœºåˆ¶ã€‘ï¼Œä»è€Œã€å¯æŒç»­æ•ˆç›Šã€‘`
            };

            const drill = miltonDrills[epochDays % miltonDrills.length];
            const patternNameMap = miltonPatterns.reduce((acc, item) => {
              acc[item.id] = item.name;
              return acc;
            }, {});
            const patternNames = drill.focus_pattern_ids.map((id) => patternNameMap[id] || id);

            const miltonBlock = `## ğŸ—£ï¸ ç±³å°”é¡¿è¯­è¨€å¾®ç»ƒä¹ \n<!-- MILTON_BLOCK_START -->\n\n- ä»Šæ—¥çœŸå®æ²Ÿé€šåœºæ™¯ï¼ˆè‡ªç”±å†™ä¸€å¥è¯ï¼‰ï¼š\n  ä¾‹ï¼š________________________________\n\n- æˆ‘æƒ³è¾¾æˆçš„æ•ˆæœï¼ˆè‡ªç”±å†™ä¸€å¥è¯ï¼‰ï¼š\n  ä¾‹ï¼š________________________________\n\n- é»˜è®¤ç»ƒä¹ ï¼ˆ14 å¤©æ¸¸ç¨‹ï¼‰ï¼š\n  - ç¬¬ ${drill.day} å¤©ç»ƒä¹ \n  - ä»Šæ—¥èšç„¦æ¨¡å¼ï¼š${patternNames.join(' / ')}\n  - ç»ƒä¹ ä»»åŠ¡ï¼š${drill.task}\n  - è¾“å…¥é™åˆ¶ï¼š${drill.input_format}\n  - è‡ªæ£€æ¸…å•ï¼š\n${drill.self_check.map((item) => `    - ${item}`).join('\n')}\n\n- æˆ‘çš„æ”¹å†™ï¼š\n- æˆ‘å‡†å¤‡åœ¨å“ªæ¬¡çœŸå®æ²Ÿé€šä¸­ä½¿ç”¨ï¼š\n\n<!-- MILTON_BLOCK_END -->`;

            const body = `### æ—¥æœŸ\n${year}-${month}-${day}ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰\n\n${moduleSections[moduleToday]}\n\n${miltonBlock}\n\n---\nè¯·ç”¨5åˆ†é’Ÿå†…å®Œæˆï¼Œä»Šæ—¥æ¨¡å—ï¼š${moduleToday}`;

            await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels: ['daily'],
            });
