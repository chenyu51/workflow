name: Weekly Issue Automation (Growth OS v2)

on:
  # Cron uses UTC. Beijing = UTC+8 with no daylight saving time.
  # Beijing Friday 18:00 (UTC+8) → UTC 10:00.
  schedule:
    - cron: '0 10 * * 5'
  workflow_dispatch:

permissions:
  issues: write

jobs:
  create-weekly-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Create or reuse weekly issue
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const beijing = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Shanghai' }));
            const datePart = `${beijing.getFullYear()}-${String(beijing.getMonth() + 1).padStart(2, '0')}-${String(beijing.getDate()).padStart(2, '0')}`;

            const target = new Date(Date.UTC(beijing.getFullYear(), beijing.getMonth(), beijing.getDate()));
            const dayNum = target.getUTCDay() || 7;
            target.setUTCDate(target.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(target.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil(((target - yearStart) / 86400000 + 1) / 7);
            const year = target.getUTCFullYear();
            const week = String(weekNo).padStart(2, '0');
            const title = `${year}-W${week} Weekly`;

            const existing = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: 'open',
              per_page: 100,
            });
            if (existing.find((issue) => issue.title === title)) {
              core.info(`Issue "${title}" already exists and is open. Skipping creation.`);
              return;
            }

            async function ensureLabel(name) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name });
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({ owner, repo, name, color: 'cfd3d7', description: 'Auto-created for growth workflow' });
                } else {
                  throw error;
                }
              }
            }
            await ensureLabel('weekly');

            const body = `### 周期\n${title}（北京时间周序）\n\n## 本周我在哪些方面真实成长了？\n- [ ]\n\n## 哪些是“看似努力但没拉开差距”的事？\n- [ ]\n\n## 本周结构化思考：我掌握了什么“框架”？\n- [ ]\n\n## 本周外部雷达：哪条信息最值得持续关注？为什么？\n- [ ]\n\n## 本周价值复盘：我为团队/公司带来的最大价值是什么？证据是什么？\n- [ ]\n\n## 下周只保留 1 个强化点，它是什么？（重点+行动）\n- [ ]\n\n参考日期（北京时间）：${datePart}`;

            await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels: ['weekly'],
            });
