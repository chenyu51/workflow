name: Weekly Issue Automation

on:
  # Cron is in UTC. 13:00 UTC ≈ 08:00 Toronto (EST) / 09:00 Toronto (EDT).
  # Adjust the hour/minute here if you want a different local time.
  schedule:
    - cron: '0 13 * * 5'
  workflow_dispatch:

permissions:
  issues: write

jobs:
  create-weekly-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Create or reuse weekly issue
        uses: actions/github-script@v7
        with:
          script: |
            const tz = 'America/Toronto';
            const now = new Date(new Date().toLocaleString('en-US', { timeZone: tz }));

            const target = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
            const dayNum = target.getUTCDay() || 7;
            target.setUTCDate(target.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(target.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil(((target - yearStart) / 86400000 + 1) / 7);
            const year = target.getUTCFullYear();
            const week = String(weekNo).padStart(2, '0');
            const title = `${year}-W${week} Weekly`;

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            async function ensureLabel(name) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name });
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({ owner, repo, name, color: 'cfd3d7', description: 'Auto-created for growth workflow' });
                } else {
                  throw error;
                }
              }
            }

            const existing = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: 'open',
              per_page: 100,
            });
            if (existing.find((issue) => issue.title === title)) {
              core.info(`Issue "${title}" already exists and is open. Skipping creation.`);
              return;
            }

            await ensureLabel('weekly');

            const body = `## 本周我在哪些方面真实成长了？\n- [ ]\n\n## 哪些是“看似努力但没拉开差距”的事？\n- [ ]\n\n## 下周只保留 1 个强化点，它是什么？（重点+行动）\n- [ ]\n`;

            await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels: ['weekly'],
            });
