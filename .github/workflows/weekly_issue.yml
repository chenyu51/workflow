name: Weekly Issue Automation (Growth OS v2)

on:
  # Cron uses UTC. Beijing = UTC+8 with no daylight saving time.
  # Beijing Friday 18:00 (UTC+8) â†’ UTC 10:00.
  schedule:
    - cron: '0 10 * * 5'
  workflow_dispatch:

permissions:
  issues: write
  contents: write

jobs:
  create-weekly-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Create or reuse weekly issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const { data: repoInfo } = await github.rest.repos.get({ owner, repo });
            const defaultBranch = repoInfo.default_branch;

            const beijing = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Shanghai' }));
            const datePart = `${beijing.getFullYear()}-${String(beijing.getMonth() + 1).padStart(2, '0')}-${String(beijing.getDate()).padStart(2, '0')}`;

            // Beijing weeks run Monday 00:00 to Sunday 23:59:59 (UTC+8).
            const beijingWeekday = beijing.getDay() === 0 ? 7 : beijing.getDay();
            const weekStart = new Date(beijing);
            weekStart.setHours(0, 0, 0, 0);
            weekStart.setDate(weekStart.getDate() - (beijingWeekday - 1));
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            weekEnd.setHours(23, 59, 59, 999);

            const target = new Date(Date.UTC(beijing.getFullYear(), beijing.getMonth(), beijing.getDate()));
            const dayNum = target.getUTCDay() || 7;
            target.setUTCDate(target.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(target.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil(((target - yearStart) / 86400000 + 1) / 7);
            const year = target.getUTCFullYear();
            const week = String(weekNo).padStart(2, '0');
            const title = `${year}-W${week} Weekly`;

            const existing = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: 'open',
              per_page: 100,
            });
            if (existing.find((issue) => issue.title === title)) {
              core.info(`Issue "${title}" already exists and is open. Skipping creation.`);
              return;
            }

            const since = new Date(beijing);
            since.setDate(since.getDate() - 30);
            const allIssues = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: 'all',
              per_page: 100,
              since: since.toISOString(),
            });

            const dailyPattern = /^(\d{4}-\d{2}-\d{2}) Daily$/;
            const dailyIssues = allIssues
              .filter((issue) => !issue.pull_request)
              .map((issue) => {
                const match = issue.title.match(dailyPattern);
                if (!match) return null;
                const dayString = match[1];
                const dayDate = new Date(`${dayString}T00:00:00+08:00`);
                return { dayString, dayDate, number: issue.number, url: issue.html_url };
              })
              .filter(Boolean)
              .filter(({ dayDate }) => dayDate >= weekStart && dayDate <= weekEnd)
              .sort((a, b) => a.dayString.localeCompare(b.dayString));

            const dailyList = dailyIssues.length
              ? dailyIssues.map((item) => `- ${item.dayString}: [#${item.number}](${item.url})`).join('\n')
              : '- ï¼ˆæœ¬å‘¨æœªæ‰¾åˆ° Daily è®°å½•ï¼‰';

            async function ensureLabel(name) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name });
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({ owner, repo, name, color: 'cfd3d7', description: 'Auto-created for growth workflow' });
                } else {
                  throw error;
                }
              }
            }
            await ensureLabel('weekly');

            function readMilton(fileName) {
              const fullPath = path.join(process.cwd(), '.github', 'data', 'milton', fileName);
              return JSON.parse(fs.readFileSync(fullPath, 'utf8'));
            }

            const miltonPrompts = readMilton('prompts.json');
            const weeklyPromptTemplate = miltonPrompts.weekly_milton_review_prompt || '';
            const weeklyPrompt = weeklyPromptTemplate.replace('{{DAILY_LIST}}', dailyList);

            const miltonReviewBlock = `## ğŸ§  ç±³å°”é¡¿è¯­è¨€å¤ç›˜\n- æœ¬å‘¨æˆ‘åœ¨å“ªäº›æ²Ÿé€šä¸­ç»ƒäº†å“ªäº›æ¨¡å¼ï¼Ÿ\n- å“ªæ¡æœ€è‡ªç„¶ï¼Ÿå“ªæ¡æœ€ç”Ÿç¡¬ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ\n- ä¸‹å‘¨æˆ‘åªé€‰ 1 ä¸ªæ¨¡å¼åˆ»æ„ç»ƒï¼Œæ˜¯ä»€ä¹ˆï¼Ÿ`;

            const promptBlock = `## ğŸ¤– å¤åˆ¶ç»™ ChatGPT çš„æç¤ºè¯\n\n\`\`\`text\n${weeklyPrompt}\n\`\`\``;

            const mdPath = `journal/weekly/${year}-W${week}-weekly.md`;
            let weeklyFileExists = false;

            try {
              await github.rest.repos.getContent({ owner, repo, path: mdPath });
              weeklyFileExists = true;
              core.info(`Weekly markdown ${mdPath} already exists.`);
            } catch (error) {
              if (error.status !== 404) throw error;
            }

            if (!weeklyFileExists) {
              const weeklyMarkdown = `# ${title}\n\n> å‘¨æ€»ç»“æ¨¡æ¿ï¼šè¯·ç›´æ¥åœ¨æœ¬æ–‡ä»¶ä¸­å¡«å†™ä½ çš„å¤ç›˜å›é¡¾ã€‚å¯ä»¥è°ƒæ•´æ ¼å¼ï¼Œä½†å»ºè®®ä¿ç•™ä¸‹é¢çš„æ£€æŸ¥é¡¹ã€‚\n\n## å‘¨æœŸ\n${title}ï¼ˆåŒ—äº¬æ—¶é—´å‘¨åºï¼‰\n\n## æœ¬å‘¨èŒƒå›´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰\nå‘¨ä¸€ 00:00 - å‘¨æ—¥ 23:59ã€‚å‚è€ƒæ—¥æœŸï¼š${datePart}\n\n## æœ¬å‘¨ Daily é“¾æ¥\n${dailyList}\n\n${miltonReviewBlock}\n\n${promptBlock}\n\n## æœ¬å‘¨æˆ‘åœ¨å“ªäº›æ–¹é¢çœŸå®æˆé•¿äº†ï¼Ÿ\n- [ ]\n\n## å“ªäº›æ˜¯â€œçœ‹ä¼¼åŠªåŠ›ä½†æ²¡æ‹‰å¼€å·®è·â€çš„äº‹ï¼Ÿ\n- [ ]\n\n## æœ¬å‘¨ç»“æ„åŒ–æ€è€ƒï¼šæˆ‘æŒæ¡äº†ä»€ä¹ˆâ€œæ¡†æ¶â€ï¼Ÿ\n- [ ]\n\n## æœ¬å‘¨å¤–éƒ¨é›·è¾¾ï¼šå“ªæ¡ä¿¡æ¯æœ€å€¼å¾—æŒç»­å…³æ³¨ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ\n- [ ]\n\n## æœ¬å‘¨ä»·å€¼å¤ç›˜ï¼šæˆ‘ä¸ºå›¢é˜Ÿ/å…¬å¸å¸¦æ¥çš„æœ€å¤§ä»·å€¼æ˜¯ä»€ä¹ˆï¼Ÿè¯æ®æ˜¯ä»€ä¹ˆï¼Ÿ\n- [ ]\n\n## ä¸‹å‘¨åªä¿ç•™ 1 ä¸ªå¼ºåŒ–ç‚¹ï¼Œå®ƒæ˜¯ä»€ä¹ˆï¼Ÿï¼ˆé‡ç‚¹+è¡ŒåŠ¨ï¼‰\n- [ ]\n\nå‚è€ƒæ—¥æœŸï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼š${datePart}\n`;

              await github.rest.repos.createOrUpdateFileContents({
                owner,
                repo,
                path: mdPath,
                message: `chore: add weekly journal ${title}`,
                content: Buffer.from(weeklyMarkdown).toString('base64'),
                branch: defaultBranch,
              });
              core.info(`Created ${mdPath}`);
            }

            const mdUrl = `https://github.com/${owner}/${repo}/blob/${defaultBranch}/${mdPath}`;

            const body = `å‘¨æŠ¥ Markdown å·²ç”Ÿæˆï¼Œè¯·åœ¨ä»“åº“æ–‡ä»¶ä¸­å¡«å†™å¤ç›˜å›é¡¾ï¼š${mdUrl}\n\n### å‘¨æœŸ\n${title}ï¼ˆåŒ—äº¬æ—¶é—´å‘¨åºï¼‰\n\n## æœ¬å‘¨èŒƒå›´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰\nå‘¨ä¸€ 00:00 - å‘¨æ—¥ 23:59ã€‚å‚è€ƒæ—¥æœŸï¼š${datePart}\n\n## æœ¬å‘¨ Daily é“¾æ¥\n${dailyList}\n\n${miltonReviewBlock}\n\n${promptBlock}\n\n## æœ¬å‘¨æˆ‘åœ¨å“ªäº›æ–¹é¢çœŸå®æˆé•¿äº†ï¼Ÿ\n- [ ]\n\n## å“ªäº›æ˜¯â€œçœ‹ä¼¼åŠªåŠ›ä½†æ²¡æ‹‰å¼€å·®è·â€çš„äº‹ï¼Ÿ\n- [ ]\n\n## æœ¬å‘¨ç»“æ„åŒ–æ€è€ƒï¼šæˆ‘æŒæ¡äº†ä»€ä¹ˆâ€œæ¡†æ¶â€ï¼Ÿ\n- [ ]\n\n## æœ¬å‘¨å¤–éƒ¨é›·è¾¾ï¼šå“ªæ¡ä¿¡æ¯æœ€å€¼å¾—æŒç»­å…³æ³¨ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ\n- [ ]\n\n## æœ¬å‘¨ä»·å€¼å¤ç›˜ï¼šæˆ‘ä¸ºå›¢é˜Ÿ/å…¬å¸å¸¦æ¥çš„æœ€å¤§ä»·å€¼æ˜¯ä»€ä¹ˆï¼Ÿè¯æ®æ˜¯ä»€ä¹ˆï¼Ÿ\n- [ ]\n\n## ä¸‹å‘¨åªä¿ç•™ 1 ä¸ªå¼ºåŒ–ç‚¹ï¼Œå®ƒæ˜¯ä»€ä¹ˆï¼Ÿï¼ˆé‡ç‚¹+è¡ŒåŠ¨ï¼‰\n- [ ]\n\nå‚è€ƒæ—¥æœŸï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼š${datePart}`;

            await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels: ['weekly'],
            });
