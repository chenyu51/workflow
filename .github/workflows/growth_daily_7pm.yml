name: Growth Daily (BJT 19:00)

on:
  schedule:
    - cron: "0 11 * * 1-5" # 19:00 Asia/Shanghai (UTC+8)
  workflow_dispatch:

permissions:
  issues: write
  contents: write

jobs:
  create_growth_daily:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Growth daily issue and journal
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { owner, repo } = context.repo;

            const now = new Date(Date.now() + 8 * 60 * 60 * 1000);
            const dateStr = `${now.getUTCFullYear()}-${String(now.getUTCMonth() + 1).padStart(2, '0')}-${String(now.getUTCDate()).padStart(2, '0')}`;
            const epochDaysBeijing = Math.floor((Date.now() + 8 * 60 * 60 * 1000) / (24 * 60 * 60 * 1000));
            const title = `${dateStr} Daily`;

            const { data: repoInfo } = await github.rest.repos.get({ owner, repo });
            const defaultBranch = repoInfo.default_branch;

            const openIssues = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: 'open',
              per_page: 100
            });

            if (openIssues.some((issue) => issue.title === title)) {
              core.info(`Issue '${title}' already exists. Skip.`);
              return;
            }

            const modules = ['BASE', 'THINKING', 'RADAR', 'VALUE'];
            const moduleName = modules[epochDaysBeijing % modules.length];

            const radarPath = path.join(process.cwd(), '.github/data/radar_topics.json');
            const rolesPath = path.join(process.cwd(), '.github/data/business_roles.json');
            const valuePhrasesPath = path.join(process.cwd(), '.github/data/value_phrases.json');
            const radarTopics = JSON.parse(fs.readFileSync(radarPath, 'utf8'));
            const businessRoles = JSON.parse(fs.readFileSync(rolesPath, 'utf8'));
            const valuePhrases = JSON.parse(fs.readFileSync(valuePhrasesPath, 'utf8'));

            let moduleDetail = '';
            if (moduleName === 'BASE') {
              moduleDetail = 'BASEï¼šå›ç­”ä»Šå¤©çš„ä¸‰é—®ï¼Œå¹¶å…³æ³¨è‡ªå·±çš„èƒ½é‡çŠ¶æ€ã€‚';
            } else if (moduleName === 'THINKING') {
              moduleDetail = 'THINKINGï¼šç”¨ 5 å¥è¯ä»¥å†…æ•´ç†ä¸€ä¸ªè®©ä½ çŠ¹è±«çš„å†³ç­–æˆ–é—®é¢˜ï¼Œå…ˆå†™è§‚ç‚¹ï¼Œå†å†™ä¾æ®ã€‚';
            } else if (moduleName === 'RADAR') {
              const topic = radarTopics[epochDaysBeijing % radarTopics.length];
              const role = businessRoles[epochDaysBeijing % businessRoles.length];
              moduleDetail = `RADARï¼šé¢˜ç›®ã€Œ${topic.topic}ã€â€”â€”${topic.prompt}\nå…³æ³¨è§’è‰²ï¼š${role}`;
            } else if (moduleName === 'VALUE') {
              moduleDetail = 'VALUEï¼šä»â€œä¸šåŠ¡ç»“æœ/å›¢é˜Ÿå½±å“/ä¸ªäººæˆé•¿â€ä¸‰ä¸ªè§’åº¦å†™å‡ºä»Šå¤©çš„ä¸€å¥ä»·å€¼æç‚¼ã€‚';
            }

            const mdPath = `journal/daily/${dateStr}-daily.md`;
            let fileExists = false;
            try {
              await github.rest.repos.getContent({ owner, repo, path: mdPath });
              fileExists = true;
              core.info(`Markdown ${mdPath} already exists.`);
            } catch (error) {
              if (error.status !== 404) throw error;
            }

            if (!fileExists) {
              const renderValueSection = (section) => {
                const examples = section.examples.map((example) => `  - ${example}`).join('\n');
                return `### ${section.name}\n- ä¸‡èƒ½å¥å¼ï¼š${section.template}\n- ä¾‹å¥ï¼š\n${examples}\n`;
              };

              const valueSectionContent = `## ğŸ§­ ä»·å€¼æç‚¼ï¼ˆå¯ç›´æ¥æŠ„ç”¨ï¼‰\n` +
                `### æœ€å°å¡«å†™åŒºï¼ˆä»»æ„ä¸€æ¡å³å¯ï¼‰\n` +
                `- æˆ‘ä»Šå¤©æœ€ç¡®å®šçš„ä¸€æ¡ä»·å€¼ï¼ˆåªå†™ 1 æ¡å³å¯ï¼‰ï¼š\n` +
                `  - [ ] ç»“æœ/ç›®æ ‡ä»·å€¼ï¼š\n` +
                `  - [ ] æ•ˆç‡/æˆæœ¬ä»·å€¼ï¼š\n` +
                `  - [ ] é£é™©/è´¨é‡ä»·å€¼ï¼š\n` +
                `  - [ ] æ²‰æ·€/å¤ç”¨ä»·å€¼ï¼š\n\n` +
                `### å¥å¼æ¨¡æ¿ + ä¾‹å¥åº“\n` +
                valuePhrases.sections.map(renderValueSection).join('\n') +
                `\n#### å…œåº•å¥å¼\n` +
                `- å¦‚æœæƒ³ä¸å‡ºæ¥ï¼Œå°±å…ˆå†™è¿™ä¸€å¥ä¹Ÿç®—æœ‰æ•ˆå¤ç›˜ï¼š\n` +
                `  - ${valuePhrases.fallback}\n`;

              const content = `# ${dateStr} Daily\n\n` +
                `## ä»Šæ—¥è®°å½•\n` +
                `### 1) ä»Šå¤©æˆ‘ä¸»è¦åšäº†ä»€ä¹ˆï¼Ÿ\n- \n\n` +
                `### 2) å“ªä»¶äº‹è®©æˆ‘å˜å¼ºäº†ä¸€ç‚¹ï¼Ÿ\n- \n\n` +
                `### 3) å¦‚æœé‡æ¥ä¸€æ¬¡ï¼Œæˆ‘ä¼šæ€ä¹ˆåšï¼Ÿ\n- \n\n` +
                `## ä»Šæ—¥æ¨¡å—ï¼ˆç³»ç»Ÿç”Ÿæˆï¼‰\n` +
                `- æ¨¡å—ï¼š${moduleName}\n` +
                `${moduleDetail}\n\n` +
                `${valueSectionContent}\n\n` +
                `## è¯æ®/é“¾æ¥ï¼ˆå¯é€‰ï¼‰\n- \n`;

              await github.rest.repos.createOrUpdateFileContents({
                owner,
                repo,
                path: mdPath,
                message: `chore: add daily journal ${dateStr}`,
                content: Buffer.from(content).toString('base64'),
                branch: defaultBranch
              });
              core.info(`Created ${mdPath}`);
            }

            const mdUrl = `https://github.com/${owner}/${repo}/blob/${defaultBranch}/${mdPath}`;
            const body = [
              'è¯·åœ¨ä»“åº“ md æ–‡ä»¶ä¸­å®Œæˆå¡«å†™ï¼š',
              mdUrl,
              '',
              `ä»Šæ—¥æ¨¡å—ï¼š${moduleName}`,
              moduleDetail,
              '',
              'ä»·å€¼æç‚¼ç¤ºä¾‹ä¸å¥å¼åœ¨ md æ–‡ä»¶å†…çš„ `## ğŸ§­ ä»·å€¼æç‚¼ï¼ˆå¯ç›´æ¥æŠ„ç”¨ï¼‰` åŒºå—ï¼ŒæŒ‰ä»»æ„ä¸€ä¸ªè§†è§’å¡« 1 æ¡å³å¯ã€‚'
            ].join('\n');

            await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels: ['daily']
            });
            core.info(`Created issue ${title}`);
